# 图神经网络入门及实践

```python
# 图的实现
"""
	基本属性
	data.x: 节点特征矩阵, shape = [num_nodes, num_node_features]
    data.edge_index: 邻接矩阵, COO形式, shape = [2, num_edges]
    data.edge_attr: 边的特征矩阵, shape = [num_edges, num_edge_features]
    data.y: 图的标签, 节点级任务 shape = [num_nodes, ] 或 图级任务 shape = [1, ]
"""
import torch
from torch_geometric.data import Data

edge_index = torch.tensor([[0, 1, 1, 2],
                           [1, 0, 2, 1]], dtype=torch.long)
x = torch.tensor([[-1], [0], [1]], dtype=torch.float)

data = Data(x=x, edge_index=edge_index)
print(data)

conv = GCNConv(1, 5, cached=True)
x, y,edge_index = data.x, data.y,data.edge_index
x = conv1(x, edge_index)
print(x)
print(y.shape)
```

```python
# 使用GCNConv
import torch
from torch_geometric.data import Data
from torch_geometric.nn import GCNConv

x = torch.tensor([[2,1], [5,6], [3,7], [12,0]],dtype=torch.float)
y = torch.tensor([[0]],dtype=torch.long)

edge_index = torch.tensor([[0,1,2,0,3],
                           [1,0,1,3,2]],dtype=torch.long)

data = Data(x=x,y=y,edge_index=edge_index)
print(data)

# in_channels: 输入节点的特征数量
# out_channels: 输出节点的特征数量
conv1 = GCNConv(2, 5, cached=True)
x, y,edge_index = data.x, data.y,data.edge_index
x = conv1(x, edge_index)
print(x)
print(y.shape)
```

环境配置

https://pytorch-geometric.readthedocs.io/en/latest/notes/installation.html

Data源码

https://pytorch-geometric.readthedocs.io/en/latest/_modules/torch_geometric/data/data.html#Data

```shell
# 安装cgcnn并测试
# 准备工作
# 1. anaconda的安装 https://www.anaconda.com/
sh Anaconda3-2021.11-Linux-x86_64.sh

# 2.创建环境 name=cgcnn，并激活
conda create -n cgcnn python=3.6
conda activate cgcnn

# 3.安装对应版本的pytorch
# https://pytorch.org/get-started/locally/
# 下载CGCNN
git clone https://github.com/txie-93/cgcnn.git
# 或进入github下载zip

# 查看cgcnn文件结构
cd cgcnn-mater;ls
# 查看使用说明
python main.py -h
# 用样本数据集进行训练
python main.py --train-ratio 0.6 --val-ratio 0.2 --test-ratio 0.2 data/sample-regression
# 查看数据集文件
cd data/sample-regression;ls
# 查看id_prop.csv
vim id_prop.csv
# 使用说明：只需要替换数据集文件，将数据集文件夹中的晶体cif文件替换，并替换为相应的id_prop.csv
# atom_init.json直接拷贝即可
```

```shell
cgcnn文件结构
cgcnn-master
	|_cgcnn:模型文件夹
		|_init.py: 空文件
		|_data.py: 处理数据，将晶体的cif文件转换为图数据
		|_model.py: 模型文件，定义了图卷积层与完整模型
	|_data:数据集文件夹
		|_sample-regression: 回归样本数据集
			|_xxx.cif: 晶体的cif文件
			|_xxx.cif
			...
			|_id_prop.csv: 目标属性
			|_atom_init.json: 原子的特征向量
		|_sample-regression: 分类样本数据集
	|_checkpoint.pth.tar: 断点保存的压缩文件
	|_model_best_pth.tar: 上次训练保存的最佳模型
	|_pre-trained: 预先训练的模型
	|_test_results.csv: 上次训练完成的预测结果
	|_main.py: 训练的运行文件
	|_predict.py: 预测的运行文件
```

```
main.py 主要参数
--task: 任务类别，回归或分类，默认回归
--disable-cuda: 是否使用CUDA加速
--epochs: 训练迭代的次数，默认30次
--lr: 初始学习率，默认0.01
--momentum: 动量
--weight-decay: 权重衰减
--train-ratio: 训练集比例(0-1)
--train-size: 训练集样本数
--val-ratio: 验证机比例(0-1)
--val-size: 验证集样本数
--test-ratio: 测试集比例(0-1)
--test-size: 测试集样本数
--optim: 优化器，默认SGD，仅支持(SGD和Adam)
--atom-fea-len: 原子特征向量维度
--n-conv: 卷积层数量
--n-h: 隐藏层数量
```

